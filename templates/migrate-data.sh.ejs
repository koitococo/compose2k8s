#!/usr/bin/env bash
# Database Migration Script
# Generated by compose2k8s
#
# Database type: <%= dbType %>
# Service: <%= serviceName %>
# Namespace: <%= namespace %>
#
# This script provides commands to migrate data from a Docker Compose
# deployment to Kubernetes.

set -euo pipefail

NAMESPACE="<%= namespace %>"
SERVICE="<%= k8sName %>"
<% if (dbType === 'postgres') { %>
DB_USER="<%= dbUser %>"
DB_NAME="<%= dbName %>"
DUMP_FILE="pg_dump_${DB_NAME}_$(date +%Y%m%d_%H%M%S).sql"

echo "=== Step 1: Export from Docker Compose ==="
docker compose exec <%= serviceName %> pg_dump -U "${DB_USER}" -d "${DB_NAME}" > "${DUMP_FILE}"

echo "=== Step 2: Copy to Kubernetes ==="
POD=$(kubectl get pods -n "${NAMESPACE}" -l "app.kubernetes.io/name=${SERVICE}" -o jsonpath='{.items[0].metadata.name}')
kubectl cp "${DUMP_FILE}" "${NAMESPACE}/${POD}:/tmp/${DUMP_FILE}"

echo "=== Step 3: Import in Kubernetes ==="
kubectl exec -n "${NAMESPACE}" "${POD}" -- psql -U "${DB_USER}" -d "${DB_NAME}" -f "/tmp/${DUMP_FILE}"
<% } else if (dbType === 'mysql') { %>
DB_USER="<%= dbUser %>"
DB_NAME="<%= dbName %>"
DUMP_FILE="mysql_dump_${DB_NAME}_$(date +%Y%m%d_%H%M%S).sql"

echo "=== Step 1: Export from Docker Compose ==="
docker compose exec <%= serviceName %> mysqldump -u "${DB_USER}" -p "${DB_NAME}" > "${DUMP_FILE}"

echo "=== Step 2: Copy to Kubernetes ==="
POD=$(kubectl get pods -n "${NAMESPACE}" -l "app.kubernetes.io/name=${SERVICE}" -o jsonpath='{.items[0].metadata.name}')
kubectl cp "${DUMP_FILE}" "${NAMESPACE}/${POD}:/tmp/${DUMP_FILE}"

echo "=== Step 3: Import in Kubernetes ==="
kubectl exec -n "${NAMESPACE}" "${POD}" -- mysql -u "${DB_USER}" -p "${DB_NAME}" < "/tmp/${DUMP_FILE}"
<% } else if (dbType === 'mongo') { %>
DB_NAME="<%= dbName %>"
DUMP_DIR="mongodump_${DB_NAME}_$(date +%Y%m%d_%H%M%S)"

echo "=== Step 1: Export from Docker Compose ==="
docker compose exec <%= serviceName %> mongodump --db "${DB_NAME}" --out "/tmp/${DUMP_DIR}"
docker compose cp <%= serviceName %>:/tmp/${DUMP_DIR} ./${DUMP_DIR}

echo "=== Step 2: Copy to Kubernetes ==="
POD=$(kubectl get pods -n "${NAMESPACE}" -l "app.kubernetes.io/name=${SERVICE}" -o jsonpath='{.items[0].metadata.name}')
kubectl cp "./${DUMP_DIR}" "${NAMESPACE}/${POD}:/tmp/${DUMP_DIR}"

echo "=== Step 3: Import in Kubernetes ==="
kubectl exec -n "${NAMESPACE}" "${POD}" -- mongorestore --db "${DB_NAME}" "/tmp/${DUMP_DIR}/${DB_NAME}"
<% } else if (dbType === 'redis') { %>
echo "=== Step 1: Trigger BGSAVE in Docker Compose ==="
docker compose exec <%= serviceName %> redis-cli BGSAVE
sleep 5
docker compose cp <%= serviceName %>:/data/dump.rdb ./redis_dump.rdb

echo "=== Step 2: Copy to Kubernetes ==="
POD=$(kubectl get pods -n "${NAMESPACE}" -l "app.kubernetes.io/name=${SERVICE}" -o jsonpath='{.items[0].metadata.name}')
kubectl cp ./redis_dump.rdb "${NAMESPACE}/${POD}:/data/dump.rdb"

echo "=== Step 3: Restart Redis to load dump ==="
kubectl delete pod -n "${NAMESPACE}" "${POD}"
echo "Pod will be recreated and load the RDB file."
<% } %>

echo ""
echo "=== Migration complete ==="
